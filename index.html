<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<title>Open Issues Dashboard (Ordered)</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
:root {
  --bg: #111;
  --panel: #1c1f24;
  --panel-alt: #242a30;
  --txt: #eee;
  --accent: #4da3ff;
  --warn: #ffcc33;
  --danger: #ff5f56;
  --ok: #5fbf6a;
  --hold: #b084ff;
  --border: #333;
  --phase: #2d3742;
  --font: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  --font-scale: 1;
}
body {
  margin: 0;
  padding: 0;
  background: var(--bg);
  color: var(--txt);
  font-family: var(--font);
}
html {
  font-size: calc(var(--font-scale) * 100%);
  transition: font-size 0.2s ease;
}
header {
  display: flex;
  flex-wrap: wrap;
  gap: .75rem;
  align-items: center;
  margin: 1rem 1.25rem;
  background: var(--panel-alt);
  padding: .5rem 1.25rem;
}
select,
input[type="search"],
input[type="range"] {
  background: var(--panel);
  color: var(--txt);
  border: 1px solid var(--border);
  padding: .35rem .5rem;
  border-radius: 4px;
}
button {
  background: var(--accent);
  color: #fff;
  border: none;
  padding: .5rem 1rem;
  border-radius: 5px;
  font-size: .8rem;
  cursor: pointer;
}
button#saveUpdatesBtn {
  background: var(--ok);
}
#issuesTable {
  width: 100%;
  border-collapse: collapse;
  margin: 1rem 1.25rem;
}
#issuesTable th {
  background: var(--panel-alt);
  padding: .5rem;
  text-align: left;
}
#issuesTable td {
  background: var(--panel);
  padding: .5rem;
  vertical-align: top;
}
#issuesTable td:nth-child(6),
#issuesTable td:nth-child(8) {
  font-size: .9rem;
}
#issuesTable tbody tr:nth-child(even) td {
  background: var(--panel-alt);
}
.phase-badge {
  background: var(--phase);
  color: #fff;
  border-radius: 3px;
  padding: .2rem .4rem;
  font-size: .7rem;
}
.badge-my {
  background: var(--panel-alt);
  color: var(--txt);
  border-radius: 3px;
  padding: .2rem .4rem;
  font-size: .7rem;
  margin-left: .3rem;
}

/* Priority badge styling */
.priority-badge { display: inline-block; padding: .2rem .4rem; border-radius: 3px; font-size: .7rem; font-weight: 600; text-align: center; }
.priority-1 { background: var(--danger); color: #fff; }
.priority-2 { background: var(--warn);   color: #000; }
.priority-3 { background: var(--ok);     color: #fff; }
.priority-4 { background: var(--accent); color: #fff; }

/* Horizontal divider between program groups */
.program-break td { border-top: 2px solid #333; }
/* Dark-mode override: thicker, lighter dividers */
body:not(.light-mode) .program-break td {
  border-top-width: 3px;
  border-top-style: solid;
  border-top-color: #888;
}

body.light-mode {
  --bg: #fefefe;
  --panel: #fff;
  --panel-alt: #f7f7f7;
  --txt: #111;
}

/* Details and Summary styling for Notes section */
details {
  margin: 0;
  padding: 0;
}

details summary {
  list-style: none;
  cursor: pointer;
  padding: 0;
  margin: 0;
  text-align: left;
  color: var(--txt);
  font-size: .6rem;
}

details summary::-webkit-details-marker {
  display: none;
}

details[open] summary {
  margin-bottom: .5rem;
}

/* Date picker styling */
.date-picker-container {
  position: relative;
  display: inline-block;
}

.date-picker-popup {
  position: absolute;
  top: 100%;
  left: 0;
  background: var(--panel-alt);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: .5rem;
  box-shadow: 0 2px 8px rgba(0,0,0,.3);
  z-index: 1000;
  min-width: 200px;
}

.date-picker-row {
  display: flex;
  gap: .3rem;
  margin-bottom: .3rem;
  align-items: center;
}

.date-picker-row select {
  flex: 1;
  background: var(--panel);
  color: var(--txt);
  border: 1px solid var(--border);
  padding: .25rem;
  border-radius: 3px;
  font-size: .6rem;
}

.date-display {
  font-size: .6rem;
  padding: .2rem .4rem;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 3px;
  margin-bottom: .2rem;
}

.select-date-btn {
  background: var(--accent);
  color: #fff;
  border: none;
  padding: .2rem .4rem;
  border-radius: 3px;
  font-size: .6rem;
  cursor: pointer;
}

/* Program menu styling */
.program-menu-container {
  position: relative;
  display: inline-block;
}

.program-menu {
  position: absolute;
  top: 100%;
  left: 0;
  background: var(--panel-alt);
  border: 1px solid var(--border);
  border-radius: 4px;
  box-shadow: 0 2px 8px rgba(0,0,0,.3);
  z-index: 1000;
  min-width: 120px;
  display: none;
}

.program-menu-item {
  padding: .5rem .75rem;
  cursor: pointer;
  font-size: .7rem;
  border-bottom: 1px solid var(--border);
  transition: background-color 0.2s;
}

.program-menu-item:last-child {
  border-bottom: none;
}

.program-menu-item:hover {
  background: var(--panel);
}
</style>
</head>
<body>
<!-- Main content starts -->

<!-- Add New Issue Button -->
<header>
  <button id="addIssueBtn">Add New Issue</button>
  <button id="saveUpdatesBtn">Save Updates</button>
    <span id="saveSpinner" style="display:none;margin-left:.5rem;">‚è≥ Saving...</span>
  <label for="filterProgram">Program</label>
  <select id="filterProgram">
    <option value="">All</option>
    <option>CX727</option>
    <option>P708</option>
    <option>HVF</option>
    <option>General</option>
  </select>
  <label for="filterPhase">Phase</label>
  <select id="filterPhase">
    <option value="">All</option>
  </select>
  <label for="filterPriority">Priority</label>
  <select id="filterPriority">
    <option value="">All</option>
    <option value="1">1 - Urgent and Important</option>
    <option value="2">2 - Important but Not Urgent</option>
    <option value="3">3 - Urgent but Not Important</option>
    <option value="4">4 - Neither Urgent nor Important</option>
  </select>
  <label for="filterMY">Model Year</label>
  <select id="filterMY">
    <option value="">All</option>
  </select>
  <label for="searchBox">Search</label>
  <input id="searchBox" type="search" placeholder="Any text..." />
  <label for="showClosed">Show Closed</label>
  <select id="showClosed">
    <option value="0">No</option>
    <option value="1">Yes</option>
  </select>
  <label for="fontSizeRange">Font Size</label>
  <input type="range" id="fontSizeRange" min="0.75" max="1.5" step="0.05" value="1" />
  <button id="toggleThemeBtn">üåô</button>
  <div id="stats"></div>
</header>

<!-- Add New Issue Modal -->
<div id="addIssueModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,.55);z-index:1000;align-items:center;justify-content:center;">
  <div style="background:var(--panel);padding:2rem 2.5rem;border-radius:8px;min-width:320px;max-width:95vw;box-shadow:0 2px 16px #0008;position:relative;">
    <h2 style="margin-top:0;font-size:1rem;">Add New Issue</h2>
    <form id="addIssueForm">
      <div style="margin-bottom:.7rem;">
        <label for="newProgram">Program</label>
        <select id="newProgram" required style="width:100%;background:var(--panel-alt);color:var(--txt);border:1px solid var(--border);padding:.45rem .55rem;border-radius:4px;">
          <option value="">Select...</option>
          <option>CX727</option>
          <option>P708</option>
          <option>HVF</option>
          <option>General</option>
        </select>
      </div>
      <div style="margin-bottom:.7rem;">
        <label for="newPriority">Priority</label>
        <select id="newPriority" style="width:100%;background:var(--panel-alt);color:var(--txt);border:1px solid var(--border);padding:.45rem .55rem;border-radius:4px;">
          <option value="">Select...</option>
          <option>Urgent and Important</option>
          <option>Important but Not Urgent</option>
          <option>Urgent but Not Important</option>
          <option>Neither Urgent nor Important</option>
        </select>
      </div>
      <div style="margin-bottom:.7rem;">
        <label for="newItem">Item Description</label>
        <input id="newItem" type="text" required style="width:100%;background:var(--panel-alt);color:var(--txt);border:1px solid var(--border);padding:.45rem .55rem;border-radius:4px;" />
      </div>
      <div style="margin-bottom:.7rem;">
        <label for="newStatus">Status</label>
        <select id="newStatus" required style="width:100%;background:var(--panel-alt);color:var(--txt);border:1px solid var(--border);padding:.45rem .55rem;border-radius:4px;">
          <option value="">Select...</option>
          <option>Open</option>
          <option>In Progress</option>
          <option>On Hold</option>
          <option>Approved</option>
          <option>Closed</option>
          <option>Duplicate</option>
          <option>Urgent</option>
          <option>Implementation</option>
          <option>Planning</option>
        </select>
      </div>
      <div style="margin-bottom:.7rem;">
        <label for="newNext">Next Steps</label>
        <input id="newNext" type="text" style="width:100%;background:var(--panel-alt);color:var(--txt);border:1px solid var(--border);padding:.45rem .55rem;border-radius:4px;" />
      </div>
      <div style="margin-bottom:.7rem;">
        <label for="newMY">Model Year (MY)</label>
        <select id="newMY" style="width:100%;background:var(--panel-alt);color:var(--txt);border:1px solid var(--border);padding:.45rem .55rem;border-radius:4px;">
          <option value="">Select...</option>
          <option>25MY</option>
          <option>26MY</option>
          <option>26.5MY</option>
          <option>27MY</option>
          <option>28MY</option>
          <option>29MY</option>
          <option>30MY</option>
          <option>31MY</option>
        </select>
      </div>
      <div style="margin-bottom:.7rem;">
        <label for="newPhase">Implementation Phase</label>
        <select id="newPhase" style="width:100%;background:var(--panel-alt);color:var(--txt);border:1px solid var(--border);padding:.45rem .55rem;border-radius:4px;">
          <option value="">Select...</option>
          <option>Concept</option>
          <option>On Hold</option>
          <option>PP</option>
          <option>TT</option>
          <option>MP1</option>
          <option>MP2</option>
          <option>RC</option>
          <option>Planning</option>
          <option>Personal</option>
        </select>
      </div>
      <div style="display:flex;gap:1rem;justify-content:flex-end;margin-top:1.2rem;">
        <button type="button" id="cancelAddIssue" style="background:var(--border);color:var(--txt);border:none;padding:.45rem 1.1rem;border-radius:5px;cursor:pointer;">Cancel</button>
        <button type="submit" style="background:var(--accent);color:#fff;border:none;padding:.45rem 1.1rem;border-radius:5px;cursor:pointer;">Add Issue</button>
      </div>
    </form>
  </div>
</div>

<table id="issuesTable">
  <thead>
    <tr>
      <th style="min-width:130px">Implementation Phase / MY</th>
      <th>Program</th>
      <th>Priority</th>
      <th>Item</th>
      <th>Status</th>
      <th>Next Steps</th>
      <th>Completion Date</th>
      <th>Notes</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<footer>
  Program filter limited to CX727, P708, HVF, General. Phase label renamed to Implementation Phase. Update data array to maintain.
</footer>

<script>
/*
Phases used: Concept, Planning, PP, Implementation, Validation, Release, Closure,
Documentation, Launch, Rework, OnHold, Personal
Status normalized: Open, In Progress, On Hold, Approved, Closed, Duplicate, Urgent, Implementation, Planning
*/
// Ordered & normalized from provided list
const rawIssues = [
  /* ----------------- CX727 ----------------- */
  {
    program:"CX727",
    priority:"",
    item:"Alert A14820600 allow Kostal send parts AD instead of AC for PP build event 26MY",
    status:"In Progress",
    next:"Confirm shipment of AD (D level) SCCM parts; ensure arrival before PP build",
    target:"Need parts prior 09/12 (request by 09/05)",
    modelYear:"26MY",
    phase:"PP",
    notes:`Need approved alert (got 9/01). 8/28: push approval ASAP. 9/09: Kostal ship by 9/11; Gil to confirm w/ Ivan.`
  },
  {
    program:"CX727",
    priority:"",
    item:"DCR 1595 ESC Button Removal TVM (Electronic Stability Control)",
    status:"In Progress",
    next:"Collect AVD data (3‚Äì4 wks) then late Sept analysis; confirm rejection or proceed",
    target:"Earliest analysis 3rd/4th week Sept (orig 05/27/2025 timeline notes)",
    modelYear:"27MY",
    phase:"Concept",
    notes:`CR C14781645 raised. FMVSS 101 evaluation & soft vs hard switch feasibility. Multiple follow‚Äëups (6/6,7/09,8/05,8/12,8/20). 8/20: Corrected signal found; data collection start. Need meetings (Scott, Sanyam, feature team).`
  },
  {
    program:"CX727",
    priority:"",
    item:"HLS Chrome removal replace with MIC JA6 black ring (CR C14781693)",
    status:"On Hold",
    next:"Reject 26MY CR & create new 27MY CR + updated 2‚Äëpager",
    target:"TBD",
    modelYear:"27MY",
    phase:"OnHold",
    notes:`Supplier quote pending (BCS). Move to 27MY (9/01). Follow‚Äëups 6/6 -> 9/01. Need new savings, new CR, reject old.`
  },
  {
    program:"CX727",
    priority:"",
    item:"FEDE req PEC JOB 2 evidence package",
    status:"Closed",
    next:"Add to BPR 09/08",
    target:"Completed 08/28",
    modelYear:"‚Äî",
    phase:"Closure",
    notes:`Evidence 100% uploaded 8/20. Multiple follow‚Äëups through 9/01 for inclusion in BPR.`
  },
  {
    program:"CX727",
    priority:"4",
    item:"PWS De-chrome (CR C14799050) move to 27MY / maybe 26.5MY",
    status:"In Progress",
    next:"Modify 2‚Äëpager & new CR for 27MY; evaluate 26.5MY or Job2 entry",
    target:"‚Äî",
    modelYear:"27MY",
    phase:"Planning",
    notes:`Finance vet pending; deck limitation (27MY not in WERS). 9/09: check 26.5MY TT build Dec; confirm with program & Sheryl.`
  },
  {
    program:"CX727",
    priority:"3",
    item:"PWS Quality CR (C14675043)",
    status:"Duplicate",
    next:"Close duplicate entry",
    target:"‚Äî",
    modelYear:"‚Äî",
    phase:"Rework",
    notes:`B screen needed (due 8/29). 9/01: reminder for Alejandro approval. Marked duplicate.`
  },
  {
    program:"CX727",
    priority:"2",
    item:"DCR 1597 PTS Chrome removal (CRID 1220351 / CR C14801318)",
    status:"In Progress",
    next:"Finance vet; CPDEF scheduling; decide 26.5MY vs 27MY; create alert if entering PP",
    target:"Plan CPDEF (earlier ‚Äònext week‚Äô); reevaluate after 9/09 meeting",
    modelYear:"27MY",
    phase:"Planning",
    notes:`Cost save $1.2633/veh. Numerous finance vet follow‚Äëups (7/09‚Üí9/01). 9/09: Not in PP; consider obsolescence, illumination requirements.`
  },
  {
    program:"CX727",
    priority:"*",
    item:"C14820681 PWS Quality Issue",
    status:"Approved",
    next:"Issue notice",
    target:"‚Äî",
    modelYear:"26MY",
    phase:"Implementation",
    notes:`CR approved 9/09; pending notice issuance.`
  },
  {
    program:"CX727",
    priority:"5",
    item:"Alert A14800403 AUTHORIZE SCCM PTR @ CSAP AD level SW trial",
    status:"In Progress",
    next:"Run PTR trials (coordinate MP&L & EOL); confirm required quantity (32?)",
    target:"PP 09/06/2025",
    modelYear:"26MY",
    phase:"PP",
    notes:`Alert approved 8/12. PTR parts logistics; 9/09: parts ready (Sergio & Gerardo). Shortage of PCBs earlier.`
  },
  {
    program:"CX727",
    priority:"7",
    item:"C14813133 26MY UPDATE SCCM AUTOSAR NM improve behavior (SW change DC1630)",
    status:"In Progress",
    next:"Get APCI approval; schedule & prepare for Six Eyes 09/30; verify assembly structure",
    target:"Six Eyes 09/30",
    modelYear:"26MY",
    phase:"Implementation",
    notes:`Supplier dev ~10 days. Need separate CR per MY. 9/09: push APCI approval.`
  },
  {
    program:"CX727",
    priority:"",
    item:"28MY N button monostable shifter",
    status:"Open",
    next:"Discuss in Justin's meeting (weekly); track decision",
    target:"‚Äî",
    modelYear:"28MY",
    phase:"Concept",
    notes:`Follow‚Äëups 8/12,8/20,9/01,9/09.`
  },
  {
    program:"CX727",
    priority:"",
    item:"28MY new assumptions (Neutral behavior, steering wheel, CL&U max defrost relocation)",
    status:"Open",
    next:"Review compatibility (S650 SW) w/ Yas & Jorge; document 3 proposed changes",
    target:"‚Äî",
    modelYear:"28MY",
    phase:"Concept",
    notes:`Meeting 8/25; 9/01 list captured.`
  },
  {
    program:"CX727",
    priority:"",
    item:"HLS MAX frost removal (28MY)",
    status:"Open",
    next:"Reschedule meeting with HLS & Gang Switch D&R + Ergo",
    target:"‚Äî",
    modelYear:"28MY",
    phase:"Concept",
    notes:`Need jewel indicator decision. 9/09: meeting reschedule.`
  },
  {
    program:"CX727",
    priority:"",
    item:"VBOM for 26MY PPs",
    status:"In Progress",
    next:"Review & sign off; extend CSAP access through Oct",
    target:"PP start next Wed (noted 9/09)",
    modelYear:"26MY",
    phase:"PP",
    notes:`Support at CSAP first 2 days.`
  },
  {
    program:"CX727",
    priority:"6",
    item:"PTR Pin Grenade SCCM (25RC APCI)",
    status:"Urgent",
    next:"Release APCI this week",
    target:"ASAP",
    modelYear:"25RC",
    phase:"Release",
    notes:`9/09 expedite.`
  },

  /* ----------------- P708 ----------------- */
  {
    program:"P708",
    priority:"",
    item:"C14734204 Fast Sleep Network + C14809616 Decrease SCCM Memory Size Catch Up",
    status:"Implementation",
    next:"Process cost catch-up; confirm new CR scheduling",
    target:"05/02/25 (orig)",
    modelYear:"26MY RC",
    phase:"Implementation",
    notes:`Notice released; CPDEF 8/05; approved 8/20; claims issued.`
  },
  {
    program:"P708",
    priority:"",
    item:"C14744048 HLS RH cover update",
    status:"Implementation",
    next:"Monitor Feb secondary punch removal; validate timing with BCS",
    target:"05/05/25 (orig) / Feb impl",
    modelYear:"26MY",
    phase:"Implementation",
    notes:`PO released; secondary punch Feb; reviewed OK.`
  },
  {
    program:"P708",
    priority:"",
    item:"Headlamp Switch Remove Dim+ / Dim- Buttons C14767049",
    status:"Planning",
    next:"Reschedule CPDEF for 27MY; update timing & EFF points",
    target:"‚Äî",
    modelYear:"27MY",
    phase:"Planning",
    notes:`2‚Äëpager complete; should cost data gathering; moved to 27MY (9/01).`
  },
  {
    program:"P708",
    priority:"",
    item:"CRID1201454 De-Chrome window regulator switch - VP",
    status:"Planning",
    next:"Schedule CPDEF after finance vet; update 2‚Äëpager with take rates",
    target:"‚Äî",
    modelYear:"27MY",
    phase:"Planning",
    notes:`Working with Sheryl; moved to 27MY 9/01.`
  },
  {
    program:"P708",
    priority:"",
    item:"Check TVM Mega project HLS and ICP (DV evidence)",
    status:"Documentation",
    next:"Present evidence to Sean (Engineering Excellence)",
    target:"‚Äî",
    modelYear:"‚Äî",
    phase:"Documentation",
    notes:`Evidence uploaded; need email to Kim; presentation pending.`
  },
  {
    program:"P708",
    priority:"1",
    item:"4th Variant ICP",
    status:"In Progress",
    next:"Follow up drawing release (Sept 12); PO review (Sree); timing reduction",
    target:"Notice released 9/01",
    modelYear:"26MY",
    phase:"Implementation",
    notes:`Need internal/external comm emails; DI requested; quote review in progress.`
  },
  {
    program:"P708",
    priority:"",
    item:"AAGBH,BYPAK combination (27MY) for 14711",
    status:"Closed",
    next:"‚Äî",
    target:"Released",
    modelYear:"27MY",
    phase:"Closure",
    notes:`CR created & released.`
  },
  {
    program:"P708",
    priority:"",
    item:"PMT 2 BOM Issues (27MY) - create CR",
    status:"Open",
    next:"Create CR & close log with number",
    target:"‚Äî",
    modelYear:"27MY",
    phase:"Planning",
    notes:`8/20 create CR; 9/01 add CR number & close.`
  },
  {
    program:"P708",
    priority:"",
    item:"Key life test push nut change IP assembly",
    status:"Open",
    next:"Clarify ownership; add HVAC D&R; capture Frank request",
    target:"‚Äî",
    modelYear:"‚Äî",
    phase:"Validation",
    notes:`Need trial before build phases; follow‚Äëups 8/20,9/01.`
  },
  {
    program:"P708",
    priority:"",
    item:"OAC support",
    status:"Open",
    next:"Get exact support days & specs (Dalia -> Lubna)",
    target:"‚Äî",
    modelYear:"‚Äî",
    phase:"Launch",
    notes:`8/20 waiting schedule.`
  },

  /* ----------------- HVF ----------------- */
  {
    program:"HVF",
    priority:"",
    item:"Switches fasteners list",
    status:"In Progress",
    next:"Complete remaining fasteners & share with Dalia",
    target:"‚Äî",
    modelYear:"‚Äî",
    phase:"Documentation",
    notes:`Researching FedeBOM; SCCM done.`
  },
  {
    program:"HVF",
    priority:"",
    item:"Owner's manual content review (Starting & Stopping Engine) F53F59 H567 VN127",
    status:"Closed",
    next:"‚Äî",
    target:"Feedback provided",
    modelYear:"‚Äî",
    phase:"Closure",
    notes:`Review completed.`
  },
  {
    program:"HVF",
    priority:"",
    item:"31MY H768 (FNV3.4) MP1 5/2031 Pre-PS contact & switch list",
    status:"Open",
    next:"Define contacts; compile switch list migration",
    target:"‚Äî",
    modelYear:"31MY",
    phase:"Planning",
    notes:`Need change understanding first.`
  },

  /* ----------------- General ----------------- */
  {
    program:"General",
    priority:"",
    item:"2026CY P708 Launch support slow build",
    status:"Planning",
    next:"Budget travel & Canada work permits (2 trips added)",
    target:"2026CY",
    modelYear:"2026CY",
    phase:"Launch",
    notes:`Support planning.`
  },
  {
    program:"General",
    priority:"",
    item:"CPRs (PWS CX727 21MY-23MY)",
    status:"Rework",
    next:"Determine follow-up after business case rejection",
    target:"‚Äî",
    modelYear:"‚Äî",
    phase:"Rework",
    notes:`Business case rejected 7/09; JIRA Stage 4.`
  },
  {
    program:"General",
    priority:"",
    item:"Process improvements - Engineering excellence template",
    status:"In Progress",
    next:"Present 9/23 staff meeting (confirm); fill FOM template",
    target:"9/23",
    modelYear:"‚Äî",
    phase:"Implementation",
    notes:`Working with Jennifer & Jos√©; file shared with Kim.`
  },
  {
    program:"General",
    priority:"",
    item:"Trainings Problem solving Global",
    status:"In Progress",
    next:"Complete remaining exams ( >50% after 8/12 )",
    target:"07/30/25",
    modelYear:"‚Äî",
    phase:"Personal",
    notes:`1 test completed 8/20; continue 9/01.`
  },
  {
    program:"General",
    priority:"",
    item:"Trainings SPS FOM",
    status:"Open",
    next:"Finish global trainings first then SPS/FOM",
    target:"‚Äî",
    modelYear:"‚Äî",
    phase:"Personal",
    notes:`9/01 prerequisite note.`
  },
  {
    program:"General",
    priority:"",
    item:"IDP update",
    status:"Closed",
    next:"‚Äî",
    target:"Uploaded",
    modelYear:"‚Äî",
    phase:"Personal",
    notes:`IDP updated in HCM.`
  },
  {
    program:"General",
    priority:"",
    item:"Objectives and self-assessment",
    status:"Closed",
    next:"‚Äî",
    target:"Uploaded",
    modelYear:"‚Äî",
    phase:"Personal",
    notes:`Submitted before mid-day deadline.`
  },
  {
    program:"General",
    priority:"",
    item:"Self-assessment TMM",
    status:"Open",
    next:"Complete self-assessment",
    target:"‚Äî",
    modelYear:"‚Äî",
    phase:"Personal",
    notes:`9/01 pending completion.`
  }
];

// Build filter sets
const phaseSet = new Set();
const statusSet = new Set();
const mySet = new Set();

rawIssues.forEach(r=>{
  if(r.phase) phaseSet.add(r.phase);
  if(r.status) statusSet.add(r.status);
  if(r.modelYear && r.modelYear !== "‚Äî") mySet.add(r.modelYear);
});

const selPhase = document.getElementById('filterPhase');
if(selPhase){
  [...phaseSet].sort().forEach(p=>{
    const o=document.createElement('option');o.value=p;o.textContent=p;selPhase.appendChild(o);
  });
}
const selStatus = document.getElementById('filterStatus');
if(selStatus){
  [...statusSet].sort().forEach(s=>{
    const o=document.createElement('option');o.value=s;o.textContent=s;selStatus.appendChild(o);
  });
}

// Populate main Model Year filter with fixed options
const selMY = document.getElementById('filterMY');
if (selMY) {
  const years = ['', '25MY', '26MY', '26.5MY', '27MY', '28MY', '29MY', '30MY', '31MY'];
  selMY.innerHTML = '';
  years.forEach(val => {
    const o = document.createElement('option');
    o.value = val;
    o.textContent = val || 'All';
    selMY.appendChild(o);
  });
}

// Populate Add New Issue modelYear select dynamically
const newMyEl = document.getElementById('newMY');
if(newMyEl){
  newMyEl.innerHTML = `
    <option value="">Select...</option>
    <option>25MY</option>
    <option>26MY</option>
    <option>26.5MY</option>
    <option>27MY</option>
    <option>28MY</option>
    <option>29MY</option>
    <option>30MY</option>
    <option>31MY</option>
  `;
}

const tbody = document.querySelector('#issuesTable tbody');
const statsEl = document.getElementById('stats');

function render(){
  const fpEl = document.getElementById('filterProgram');
  const fp = fpEl ? fpEl.value : '';
  const prEl = document.getElementById('filterPriority');
  const pr = prEl ? prEl.value : '';
  const phEl = document.getElementById('filterPhase');
  const ph = phEl ? phEl.value : '';
  const stEl = document.getElementById('filterStatus');
  const st = stEl ? stEl.value : '';
  const myEl = document.getElementById('filterMY');
  const my = myEl ? myEl.value : '';
  const qEl = document.getElementById('searchBox');
  const q = qEl ? qEl.value.toLowerCase() : '';
  const showClosedEl = document.getElementById('showClosed');
  const showClosed = showClosedEl ? showClosedEl.value === "1" : false;

  // Clear table and prepare grouping by Program
  tbody.innerHTML = '';
  let shown = 0;
  // Group order: General, CX727, P708, HVF
  const programOrder = ['General','CX727','P708','HVF'];
  // Map to entries with original indices
  const entries = rawIssues.map((item, idx) => ({r: item, idx}));
  entries.sort((a, b) => programOrder.indexOf(a.r.program) - programOrder.indexOf(b.r.program));
  // Render each entry in sort order
  entries.forEach(({r, idx: index}) => {
     if(fp && r.program!==fp) return;
     if(ph && r.phase!==ph) return;
     if(pr){
       // Map textual priorities to numeric codes for filtering
       const textToNum = {
         'Urgent and Important': '1',
         'Important but Not Urgent': '2',
         'Urgent but Not Important': '3',
         'Neither Urgent nor Important': '4'
       };
       const priorityNum = textToNum[r.priority] || r.priority || '';
       if(priorityNum !== pr) return;
     }
     if(st && r.status!==st) return;
     if(my && r.modelYear!==my) return;
     if(!showClosed && (r.status==="Closed"||r.status==="Closure")) return;
     const hay=[r.item,r.notes,r.next,r.status,r.phase,r.modelYear].join(' ').toLowerCase();
     if(q && !hay.includes(q)) return;

    // Debug: Log the current data for this issue
    if (r.notes || r.next) {
      console.log(`Issue ${index}: Notes="${r.notes}", Next="${r.next}"`);
    }

    // Create row
    const tr = document.createElement('tr');
    // Add horizontal line when program changes from previous row
    if (index > 0 && rawIssues[index].program !== rawIssues[index-1].program) {
      tr.classList.add('program-break');
    }

    // Phase and Model Year display spans
    const phaseCell = `
      <span id="phaseDisplay_${index}" class="phase-badge phase-${r.phase||'NA'}" onclick="editPhase(${index})">${r.phase||''}</span>
      <span id="myDisplay_${index}" class="badge-my" onclick="editMy(${index})">${r.modelYear||''}</span>
    `;
    
    // Create notes section with existing notes and add comment functionality
    const displayNotes = (notes) => {
      if (!notes) return '';
      
      // Split notes by pipe separator to handle individual comments
      const comments = notes.split(' | ');
      return comments.map((comment, commentIndex) => {
        // Check if comment has timestamp format [MM/DD/YYYY HH:MM]
        const timestampMatch = comment.match(/^\[(\d{1,2}\/\d{1,2}\/\d{4} \d{1,2}:\d{2})\](.*)$/);
        
        if (timestampMatch) {
          const timestamp = timestampMatch[1];
          const commentText = timestampMatch[2].trim();
          return `
            <div style="border-bottom:1px solid var(--border);padding:.3rem 0;margin-bottom:.3rem;">
              <div style="font-size:.55rem;color:var(--accent);margin-bottom:.2rem;">[${timestamp}]</div>
              <div id="commentText_${index}_${commentIndex}" style="font-size:.6rem;margin-bottom:.3rem;">${escapeHTML(commentText)}</div>
              <textarea id="editComment_${index}_${commentIndex}" style="display:none;width:100%;background:var(--panel-alt);color:var(--txt);border:1px solid var(--border);padding:.3rem;border-radius:3px;font-size:.6rem;min-height:40px;margin-bottom:.3rem;">${escapeHTML(commentText)}</textarea>
              <div style="display:flex;gap:.3rem;">
                <button onclick="editComment(${index}, ${commentIndex})" id="editBtn_${index}_${commentIndex}" style="background:#ffa500;color:#000;border:none;padding:.25rem .6rem;border-radius:4px;font-size:.6rem;font-weight:600;cursor:pointer;box-shadow:0 1px 3px rgba(0,0,0,.3);">‚úèÔ∏è Edit</button>
                <button onclick="saveComment(${index}, ${commentIndex})" id="saveBtn_${index}_${commentIndex}" style="display:none;background:var(--ok);color:#fff;border:none;padding:.25rem .6rem;border-radius:4px;font-size:.6rem;font-weight:600;cursor:pointer;box-shadow:0 1px 3px rgba(0,0,0,.3);">üíæ Save</button>
                <button onclick="cancelEdit(${index}, ${commentIndex})" id="cancelBtn_${index}_${commentIndex}" style="display:none;background:var(--border);color:var(--txt);border:none;padding:.25rem .6rem;border-radius:4px;font-size:.6rem;font-weight:600;cursor:pointer;box-shadow:0 1px 3px rgba(0,0,0,.3);">‚ùå Cancel</button>
                <button onclick="deleteComment(${index}, ${commentIndex})" style="background:var(--danger);color:#fff;border:none;padding:.25rem .6rem;border-radius:4px;font-size:.6rem;font-weight:600;cursor:pointer;box-shadow:0 1px 3px rgba(0,0,0,.3);">üóëÔ∏è Delete</button>
              </div>
            </div>
          `;
        } else {
          // Legacy comment without timestamp
          return `
            <div style="border-bottom:1px solid var(--border);padding:.3rem 0;margin-bottom:.3rem;">
              <div style="font-size:.6rem;margin-bottom:.3rem;">${escapeHTML(comment)}</div>
            </div>
          `;
        }
      }).join('');
    };
    
    // Create next steps section with existing steps and add comment functionality
    const displayNextSteps = (nextSteps) => {
      if (!nextSteps) return '';
      
      // Split next steps by pipe separator to handle individual comments
      const steps = nextSteps.split(' | ');
      return steps.map((step, stepIndex) => {
        // Check if step has timestamp format [MM/DD/YYYY HH:MM]
        const timestampMatch = step.match(/^\[(\d{1,2}\/\d{1,2}\/\d{4} \d{1,2}:\d{2})\](.*)$/);
        
        if (timestampMatch) {
          const timestamp = timestampMatch[1];
          const stepText = timestampMatch[2].trim();
          return `
            <div style="border-bottom:1px solid var(--border);padding:.3rem 0;margin-bottom:.3rem;">
              <div style="font-size:.55rem;color:var(--accent);margin-bottom:.2rem;">[${timestamp}]</div>
              <div id="nextStepText_${index}_${stepIndex}" style="font-size:.6rem;margin-bottom:.3rem;">${escapeHTML(stepText)}</div>
              <textarea id="editNextStep_${index}_${stepIndex}" style="display:none;width:100%;background:var(--panel-alt);color:var(--txt);border:1px solid var(--border);padding:.3rem;border-radius:3px;font-size:.6rem;min-height:40px;margin-bottom:.3rem;">${escapeHTML(stepText)}</textarea>
              <div style="display:flex;gap:.3rem;">
                <button onclick="editNextStep(${index}, ${stepIndex})" id="editNextStepBtn_${index}_${stepIndex}" style="background:#ffa500;color:#000;border:none;padding:.25rem .6rem;border-radius:4px;font-size:.6rem;font-weight:600;cursor:pointer;box-shadow:0 1px 3px rgba(0,0,0,.3);">‚úèÔ∏è Edit</button>
                <button onclick="saveNextStep(${index}, ${stepIndex})" id="saveNextStepBtn_${index}_${stepIndex}" style="display:none;background:var(--ok);color:#fff;border:none;padding:.25rem .6rem;border-radius:4px;font-size:.6rem;font-weight:600;cursor:pointer;box-shadow:0 1px 3px rgba(0,0,0,.3);">üíæ Save</button>
                <button onclick="cancelEditNextStep(${index}, ${stepIndex})" id="cancelNextStepBtn_${index}_${stepIndex}" style="display:none;background:var(--border);color:var(--txt);border:none;padding:.25rem .6rem;border-radius:4px;font-size:.6rem;font-weight:600;cursor:pointer;box-shadow:0 1px 3px rgba(0,0,0,.3);">‚ùå Cancel</button>
                <button onclick="deleteNextStep(${index}, ${stepIndex})" id="deleteNextStepBtn_${index}_${stepIndex}" style="background:var(--danger);color:#fff;border:none;padding:.25rem .6rem;border-radius:4px;font-size:.6rem;font-weight:600;cursor:pointer;box-shadow:0 1px 3px rgba(0,0,0,.3);">üóëÔ∏è Delete</button>
              </div>
            </div>
          `;
        } else {
          // Legacy step without timestamp: show, edit, and allow deletion
          return `
            <div style="border-bottom:1px solid var(--border);padding:.3rem 0;margin-bottom:.3rem;">
              <div id="nextStepText_${index}_${stepIndex}" style="font-size:.6rem;margin-bottom:.3rem;">${escapeHTML(step)}</div>
              <textarea id="editNextStep_${index}_${stepIndex}" style="display:none;width:100%;background:var(--panel-alt);color:var(--txt);border:1px solid var(--border);padding:.3rem;border-radius:3px;font-size:.6rem;min-height:40px;margin-bottom:.3rem;">${escapeHTML(step)}</textarea>
              <div style="display:flex;gap:.3rem;">
                <button onclick="editNextStep(${index}, ${stepIndex})" id="editNextStepBtn_${index}_${stepIndex}" style="background:#ffa500;color:#000;border:none;padding:.25rem .6rem;border-radius:4px;font-size:.6rem;font-weight:600;cursor:pointer;box-shadow:0 1px 3px rgba(0,0,0,.3);">‚úèÔ∏è Edit</button>
                <button onclick="saveNextStep(${index}, ${stepIndex})" id="saveNextStepBtn_${index}_${stepIndex}" style="display:none;background:var(--ok);color:#fff;border:none;padding:.25rem .6rem;border-radius:4px;font-size:.6rem;font-weight:600;cursor:pointer;box-shadow:0 1px 3px rgba(0,0,0,.3);">üíæ Save</button>
                <button onclick="cancelEditNextStep(${index}, ${stepIndex})" id="cancelNextStepBtn_${index}_${stepIndex}" style="display:none;background:var(--border);color:var(--txt);border:none;padding:.25rem .6rem;border-radius:4px;font-size:.6rem;font-weight:600;cursor:pointer;box-shadow:0 1px 3px rgba(0,0,0,.3);">‚ùå Cancel</button>
                <button onclick="deleteNextStep(${index}, ${stepIndex})" id="deleteNextStepBtn_${index}_${stepIndex}" style="background:var(--danger);color:#fff;border:none;padding:.25rem .6rem;border-radius:4px;font-size:.6rem;font-weight:600;cursor:pointer;box-shadow:0 1px 3px rgba(0,0,0,.3);">üóëÔ∏è Delete</button>
              </div>
            </div>
          `;
        }
      }).join('');
    };
    
    const notesContent = `
      <details ${r.notes ? 'open' : ''}>
        <summary>${r.notes ? 'View Notes & Add Comment' : 'Add Comment'}</summary>
        <div style="max-height:300px;overflow-y:auto;">
          ${r.notes ? displayNotes(r.notes) : ''}
          <div style="border-top:1px solid var(--border);padding-top:.5rem;margin-top:.5rem;">
            <textarea id="newComment_${index}" placeholder="Add a new comment..." style="width:100%;background:var(--panel-alt);color:var(--txt);border:1px solid var(--border);padding:.3rem;border-radius:3px;font-size:.6rem;min-height:60px;resize:vertical;"></textarea>
            <button onclick="addComment(${index})" style="background:var(--accent);color:#fff;border:none;padding:.25rem .5rem;border-radius:3px;font-size:.55rem;margin-top:.3rem;cursor:pointer;">Add Comment</button>
          </div>
        </div>
      </details>
    `;
    
    const nextStepsContent = `
      <details ${r.next ? 'open' : ''}>
        <summary>${r.next ? 'View Steps & Add Update' : 'Add Next Step'}</summary>
        <div style="max-height:300px;overflow-y:auto;">
          ${r.next ? displayNextSteps(r.next) : ''}
          <div style="border-top:1px solid var(--border);padding-top:.5rem;margin-top:.5rem;">
            <textarea id="newNextStep_${index}" placeholder="Add a next step update..." style="width:100%;background:var(--panel-alt);color:var(--txt);border:1px solid var(--border);padding:.3rem;border-radius:3px;font-size:.55rem;min-height:60px;resize:vertical;"></textarea>
            <button onclick="addNextStep(${index})" style="background:var(--accent);color:#fff;border:none;padding:.25rem .5rem;border-radius:3px;font-size:.55rem;margin-top:.3rem;cursor:pointer;">Add Step</button>
          </div>
        </div>
      </details>
    `;
    
    // Priority mapping and display
    let priorityDisplay='';
    let priorityCell='';
    if(r.priority){
      const map={
        'Urgent and Important':{num:1,cls:'priority-1'},
        'Important but Not Urgent':{num:2,cls:'priority-2'},
        'Urgent but Not Important':{num:3,cls:'priority-3'},
        'Neither Urgent nor Important':{num:4,cls:'priority-4'}
      };
      if(map[r.priority]){
        const m=map[r.priority];
        priorityDisplay=`<span class="priority-badge ${m.cls}" title="${escapeHTML(r.priority)}">${m.num}</span>`;
      } else {
        // fallback for legacy values
        priorityDisplay=escapeHTML(r.priority);
      }
      priorityCell = `
        <span id="priorityDisplay_${index}" onclick="editPriority(${index})" style="cursor:pointer;" title="Click to edit priority">${priorityDisplay}</span>
        <select id="priorityEdit_${index}" style="display:none;width:100%;background:var(--panel-alt);color:var(--txt);border:1px solid var(--border);padding:.3rem;border-radius:4px;font-size:.6rem;" onchange="savePriority(${index})" onblur="cancelPriorityEdit(${index})">
          <option value="">Select...</option>
          <option value="Urgent and Important">Urgent and Important</option>
          <option value="Important but Not Urgent">Important but Not Urgent</option>
          <option value="Urgent but Not Important">Urgent but Not Important</option>
          <option value="Neither Urgent nor Important">Neither Urgent nor Important</option>
        </select>
      `;
    } else {
      priorityCell = `
        <button id="addPriorityBtn_${index}" onclick="editPriority(${index})" style="background:var(--accent);color:#fff;border:none;padding:.25rem .5rem;border-radius:4px;font-size:.6rem;cursor:pointer;">Add Priority</button>
        <select id="priorityEdit_${index}" style="display:none;width:100%;background:var(--panel-alt);color:var(--txt);border:1px solid var(--border);padding:.3rem;border-radius:4px;font-size:.6rem;" onchange="savePriority(${index})" onblur="cancelPriorityEdit(${index})">
          <option value="">Select...</option>
          <option value="Urgent and Important">Urgent and Important</option>
          <option value="Important but Not Urgent">Important but Not Urgent</option>
          <option value="Urgent but Not Important">Urgent but Not Important</option>
          <option value="Neither Urgent nor Important">Neither Urgent nor Important</option>
        </select>
      `;
    }

    tr.innerHTML=`
      <td>
        ${phaseCell}
        <select id="phaseEdit_${index}" style="display:none;width:100%;background:var(--panel-alt);color:var(--txt);border:1px solid var(--border);padding:.3rem;border-radius:4px;font-size:.6rem;" onchange="savePhase(${index})" onblur="cancelPhaseEdit(${index})">
          <option value="">Select...</option>
          <option value="Concept">Concept</option>
          <option value="On Hold">On Hold</option>
          <option value="PP">PP</option>
          <option value="TT">TT</option>
          <option value="MP1">MP1</option>
          <option value="MP2">MP2</option>
          <option value="RC">RC</option>
          <option value="Planning">Planning</option>
          <option value="Personal">Personal</option>
        </select>
       <select id="myEdit_${index}" style="display:none;width:100%;background:var(--panel-alt);color:var(--txt);border:1px solid var(--border);padding:.3rem;border-radius:4px;font-size:.6rem;" onchange="saveMy(${index})" onblur="cancelMyEdit(${index})">
          <option value="">Select...</option>
          <option>25MY</option>
          <option>26MY</option>
          <option>26.5MY</option>
          <option>27MY</option>
          <option>28MY</option>
          <option>29MY</option>
          <option>30MY</option>
          <option>31MY</option>
        </select>
      </td>
      <td onclick="showProgramMenu(${index}, event)" style="cursor:pointer;text-decoration:underline;color:var(--accent);position:relative;" title="Click to select program">
        <div class="program-menu-container">
          ${r.program}
          <div id="programMenu_${index}" class="program-menu">
            <div class="program-menu-item" onclick="selectProgram(${index}, 'CX727', event)">CX727</div>
            <div class="program-menu-item" onclick="selectProgram(${index}, 'General', event)">General</div>
            <div class="program-menu-item" onclick="selectProgram(${index}, 'P708', event)">P708</div>
            <div class="program-menu-item" onclick="selectProgram(${index}, 'HVF', event)">HVF</div>
          </div>
        </div>
      </td>
      <td>${priorityCell}</td>
      <td>
        <div id="itemDisplay_${index}">${r.item}</div>
        <textarea id="itemEdit_${index}" style="display:none;width:100%;background:var(--panel-alt);color:var(--txt);border:1px solid var(--border);padding:.3rem;border-radius:4px;font-size:.6rem;min-height:40px;resize:vertical;">${escapeHTML(r.item)}</textarea>
  <button id="itemEditBtn_${index}" onclick="editItem(${index})" style="background:#ffa500;color:#000;border:none;padding:.2rem .5rem;border-radius:4px;font-size:.6rem;cursor:pointer;margin-top:.2rem;">‚úèÔ∏è Edit</button>
        <div id="itemEditActions_${index}" style="display:none;margin-top:.3rem;">
          <button onclick="saveItem(${index})" style="background:var(--ok);color:#fff;border:none;padding:.2rem .5rem;border-radius:4px;font-size:.6rem;cursor:pointer;margin-right:.3rem;">Save</button>
          <button onclick="cancelItemEdit(${index})" style="background:var(--border);color:var(--txt);border:none;padding:.2rem .5rem;border-radius:4px;font-size:.6rem;cursor:pointer;">Cancel</button>
        </div>
      </td>
      <td class="status status-${r.status.replace(/\s/g,'')}">
        <span id="statusDisplay_${index}" onclick="editStatus(${index})" style="cursor:pointer;text-decoration:underline;color:var(--accent);">${r.status}</span>
        <select id="statusEdit_${index}" style="display:none;width:100%;background:var(--panel-alt);color:var(--txt);border:1px solid var(--border);padding:.3rem;border-radius:4px;font-size:.6rem;" onchange="saveStatus(${index})" onblur="cancelStatusEdit(${index})">
          <option value="">Select...</option>
          <option value="Open">Open</option>
          <option value="In Progress">In Progress</option>
          <option value="On Hold">On Hold</option>
          <option value="Approved">Approved</option>
          <option value="Closed">Closed</option>
          <option value="Duplicate">Duplicate</option>
          <option value="Urgent">Urgent</option>
          <option value="Implementation">Implementation</option>
          <option value="Planning">Planning</option>
        </select>
      </td>
      <td>${nextStepsContent}</td>
      <td>${getCompletionDateCell(r, index)}</td>
      <td>${notesContent}</td>
      <td></td> <!-- New Notes column -->
      <!-- Notes column rendered in place -->
    `;
    tbody.appendChild(tr);
    shown++;
  });
   
  // Compute breakdown by program
  const total = rawIssues.length;
  const counts = { CX727: 0, P708: 0, HVF: 0, General: 0 };
  rawIssues.forEach(r => { if (counts[r.program] !== undefined) counts[r.program]++; });
  const breakdown = `CX727: ${counts.CX727} | P708: ${counts.P708} | HVF: ${counts.HVF} | General: ${counts.General}`;
  statsEl.textContent = `Shown: ${shown} | ${breakdown} | Total: ${total}`;
}

// Date picker functionality
function getCompletionDateCell(r, index) {
  const completionDate = r.completionDate || '';
  const displayDate = completionDate ? formatDate(completionDate) : '';
  
  return `
    <div class="date-picker-container">
      <div id="dateDisplay_${index}" class="date-display" style="display:${displayDate ? 'block' : 'none'}">${displayDate}</div>
      <button id="selectDateBtn_${index}" class="select-date-btn" onclick="showDatePicker(${index})" style="display:${displayDate ? 'none' : 'block'}">Select Date</button>
      <button id="editDateBtn_${index}" class="select-date-btn" onclick="showDatePicker(${index})" style="display:${displayDate ? 'block' : 'none'};background:var(--warn);color:#000;">Edit Date</button>
      <div id="datePicker_${index}" class="date-picker-popup" style="display:none">
        <div class="date-picker-row">
          <select id="monthSelect_${index}">
            <option value="">Month</option>
            <option value="01">January</option>
            <option value="02">February</option>
            <option value="03">March</option>
            <option value="04">April</option>
            <option value="05">May</option>
            <option value="06">June</option>
            <option value="07">July</option>
            <option value="08">August</option>
            <option value="09">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
          </select>
        </div>
        <div class="date-picker-row">
          <select id="daySelect_${index}">
            <option value="">Day</option>
            ${Array.from({length: 31}, (_, i) => `<option value="${String(i + 1).padStart(2, '0')}">${i + 1}</option>`).join('')}
          </select>
        </div>
        <div class="date-picker-row">
          <select id="yearSelect_${index}">
            <option value="">Year</option>
            ${Array.from({length: 10}, (_, i) => {
              const year = new Date().getFullYear() + i;
              return `<option value="${year}">${year}</option>`;
            }).join('')}
          </select>
        </div>
        <div class="date-picker-row">
          <button onclick="saveDate(${index})" style="background:var(--ok);color:#fff;border:none;padding:.25rem .5rem;border-radius:3px;font-size:.6rem;cursor:pointer;margin-right:.3rem;">Save</button>
          <button onclick="cancelDatePicker(${index})" style="background:var(--border);color:var(--txt);border:none;padding:.25rem .5rem;border-radius:3px;font-size:.6rem;cursor:pointer;">Cancel</button>
        </div>
      </div>
    </div>
  `;
}

function showDatePicker(index) {
  // Hide all other date pickers
  document.querySelectorAll('.date-picker-popup').forEach(popup => {
    if (!popup.id.endsWith(`_${index}`)) {
      popup.style.display = 'none';
    }
  });
  
  const picker = document.getElementById(`datePicker_${index}`);
  const currentDate = rawIssues[index].completionDate;
  
  // Pre-populate if date exists
  if (currentDate) {
    const [year, month, day] = currentDate.split('-');
    document.getElementById(`monthSelect_${index}`).value = month;
    document.getElementById(`daySelect_${index}`).value = day;
    document.getElementById(`yearSelect_${index}`).value = year;
  }
  
  picker.style.display = 'block';
}

function saveDate(index) {
  const month = document.getElementById(`monthSelect_${index}`).value;
  const day = document.getElementById(`daySelect_${index}`).value;
  const year = document.getElementById(`yearSelect_${index}`).value;
  
  if (!month || !day || !year) {
    alert('Please select month, day, and year');
    return;
  }
  
  const dateString = `${year}-${month}-${day}`;
  rawIssues[index].completionDate = dateString;
  
  // Update display
  const displayDate = formatDate(dateString);
  document.getElementById(`dateDisplay_${index}`).textContent = displayDate;
  document.getElementById(`dateDisplay_${index}`).style.display = 'block';
  document.getElementById(`selectDateBtn_${index}`).style.display = 'none';
  document.getElementById(`editDateBtn_${index}`).style.display = 'block';
  
  cancelDatePicker(index);
  saveToLocalStorage();
}

function cancelDatePicker(index) {
  document.getElementById(`datePicker_${index}`).style.display = 'none';
}

function formatDate(dateString) {
  if (!dateString) return '';
  const [year, month, day] = dateString.split('-');
  const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  return `${monthNames[parseInt(month) - 1]} ${parseInt(day)}, ${year}`;
}

// Close date pickers when clicking outside
document.addEventListener('click', function(event) {
  if (!event.target.closest('.date-picker-container')) {
    document.querySelectorAll('.date-picker-popup').forEach(popup => {
      popup.style.display = 'none';
    });
  }
});

// Function to show Add New Issue modal when Program cell is clicked
function showAddIssueModal() {
  const addIssueModal = document.getElementById('addIssueModal');
  addIssueModal.style.display = 'flex';
}

// Program menu functions
function showProgramMenu(index, event) {
  event.stopPropagation();
  // Hide all other program menus
  document.querySelectorAll('.program-menu').forEach(menu => {
    if (!menu.id.endsWith(`_${index}`)) {
      menu.style.display = 'none';
    }
  });
  
  const menu = document.getElementById(`programMenu_${index}`);
  menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
}

function selectProgram(index, program, event) {
  event.stopPropagation();
  
  // Update the data
  rawIssues[index].program = program;
  
  // Hide the menu
  document.getElementById(`programMenu_${index}`).style.display = 'none';
  
  // Save changes and re-render
  saveToLocalStorage();
  render();
}

// Close program menus when clicking outside
document.addEventListener('click', function(event) {
  if (!event.target.closest('.program-menu-container')) {
    document.querySelectorAll('.program-menu').forEach(menu => {
      menu.style.display = 'none';
    });
  }
});

function escapeHTML(s){
  return s.replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
}

// LocalStorage functions for persistence
// Persist data to backend API
async function persistBackend() {
  try {
    await fetch('/api/issues', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(rawIssues)
    });
    console.log('Data persisted to backend');
  } catch (e) {
    console.error('Backend persist failed:', e);
  }
}

// Save to localStorage and backend
function saveToLocalStorage() {
  try {
    localStorage.setItem('issuesData', JSON.stringify(rawIssues));
    console.log('Data saved to localStorage');
    // also send to backend
    persistBackend();
  } catch (e) {
    console.error('Failed to save to localStorage:', e);
  }
}

// References for Save Updates button and spinner
const saveUpdatesBtn = document.getElementById('saveUpdatesBtn');
const saveSpinner = document.getElementById('saveSpinner');

// Initialize spinner hidden
saveSpinner.style.display = 'none';

// Bind Save Updates button click to saveUpdates handler
saveUpdatesBtn.addEventListener('click', saveUpdates);

// Unified Save Updates function
function saveUpdates() {
  // Show spinner
  saveSpinner.style.display = 'inline-block';
  saveUpdatesBtn.disabled = true;
  saveSpinner.textContent = '‚è≥ Saving...';
  saveSpinner.style.color = 'var(--txt)';
  // Persist data
  saveToLocalStorage();
  persistBackend().then(() => {
    saveSpinner.textContent = '‚úÖ Saved';
    saveSpinner.style.color = 'var(--ok)';
  }).catch(() => {
    saveSpinner.textContent = '‚ùå Error';
    saveSpinner.style.color = 'var(--danger)';
  }).finally(() => {
    setTimeout(() => {
      saveSpinner.style.display = 'none';
      saveUpdatesBtn.disabled = false;
    }, 1500);
  });
}

// Manual export: allow user to download the current dashboard (HTML with embedded data)
// function saveUpdates(){
//   saveSpinner.style.display='inline';
//   saveUpdatesBtn.disabled=true;
//   saveSpinner.textContent='‚è≥ Saving...';
//   // Always refresh localStorage copy & persist backend
//   saveToLocalStorage();
//   // Wait for backend to finish
//   persistBackend().finally(()=>{
//     saveSpinner.textContent='‚úÖ Saved';
//     saveSpinner.style.color='var(--ok)';
//     // Hide on next input change
//     document.querySelectorAll('input,select,textarea,button').forEach(el=>el.addEventListener('click',()=> saveSpinner.style.display='none', {once:true}));
//     setTimeout(()=>{ saveSpinner.style.display='none'; saveUpdatesBtn.disabled=false; }, 1000);
//   });
// }

function loadFromLocalStorage() {
  try {
    const saved = localStorage.getItem('issuesData');
    if (saved) {
      const loadedData = JSON.parse(saved);
      rawIssues.splice(0, rawIssues.length, ...loadedData);
      console.log('Data loaded from localStorage');
    }
  } catch (e) {
    console.error('Failed to load from localStorage:', e);
  }
}

function clearStoredData() {
  if (confirm('Are you sure you want to clear all stored comments and next steps? This cannot be undone.')) {
    localStorage.removeItem('issuesData');
    location.reload(); // Reload page to restore original data
  }
}

// Function to add a comment to an issue
function addComment(issueIndex) {
  const commentTextarea = document.getElementById(`newComment_${issueIndex}`);
  const newComment = commentTextarea.value.trim();
  
  if (!newComment) {
    alert('Please enter a comment before adding.');
    return;
  }
  
  // Get current date for timestamp
  const now = new Date();
  const timestamp = (now.getMonth()+1).toString().padStart(2,'0') + '/' + 
                   now.getDate().toString().padStart(2,'0') + '/' + 
                   now.getFullYear() + ' ' + 
                   now.getHours().toString().padStart(2,'0') + ':' + 
                   now.getMinutes().toString().padStart(2,'0');
  
  // Format the new comment with timestamp
  const formattedComment = `[${timestamp}] ${newComment}`;
  
  // Add to existing notes or create new notes
  if (rawIssues[issueIndex].notes) {
    rawIssues[issueIndex].notes += ` | ${formattedComment}`;
  } else {
    rawIssues[issueIndex].notes = formattedComment;
  }
  
  // Save to localStorage for persistence
  saveToLocalStorage();
  
  // Debug: Log the updated notes
  console.log('Updated notes for issue', issueIndex, ':', rawIssues[issueIndex].notes);
  
  // Clear the textarea
  commentTextarea.value = '';
  
  // Re-render the table to show the updated notes
  render();
}

// Function to edit a comment
function editComment(issueIndex, commentIndex) {
  const textDiv = document.getElementById(`commentText_${issueIndex}_${commentIndex}`);
  const textarea = document.getElementById(`editComment_${issueIndex}_${commentIndex}`);
  const editBtn = document.getElementById(`editBtn_${issueIndex}_${commentIndex}`);
  const saveBtn = document.getElementById(`saveBtn_${issueIndex}_${commentIndex}`);
  const cancelBtn = document.getElementById(`cancelBtn_${issueIndex}_${commentIndex}`);
  
  textDiv.style.display = 'none';
  textarea.style.display = 'block';
  editBtn.style.display = 'none';
  saveBtn.style.display = 'inline-block';
  cancelBtn.style.display = 'inline-block';
  
  textarea.focus();
}

// Function to save edited comment
function saveComment(issueIndex, commentIndex) {
  const textarea = document.getElementById(`editComment_${issueIndex}_${commentIndex}`);
  const newText = textarea.value.trim();
  
  if (!newText) {
    alert('Comment cannot be empty.');
    return;
  }
  
  // Get current comments array
  const comments = rawIssues[issueIndex].notes.split(' | ');
  
  // Update the specific comment, preserving timestamp
  const timestampMatch = comments[commentIndex].match(/^(\[[^\]]+\])(.*)$/);
  if (timestampMatch) {
    comments[commentIndex] = timestampMatch[1] + ' ' + newText;
  } else {
    comments[commentIndex] = newText;
  }
  
  // Update the notes
  rawIssues[issueIndex].notes = comments.join(' | ');
  
  // Save to localStorage for persistence
  saveToLocalStorage();
  
  // Re-render the table
  render();
}

// Function to cancel edit
function cancelEdit(issueIndex, commentIndex) {
  const textDiv = document.getElementById(`commentText_${issueIndex}_${commentIndex}`);
  const textarea = document.getElementById(`editComment_${issueIndex}_${commentIndex}`);
  const editBtn = document.getElementById(`editBtn_${issueIndex}_${commentIndex}`);
  const saveBtn = document.getElementById(`saveBtn_${issueIndex}_${commentIndex}`);
  const cancelBtn = document.getElementById(`cancelBtn_${issueIndex}_${commentIndex}`);
  
  textDiv.style.display = 'block';
  textarea.style.display = 'none';
  editBtn.style.display = 'inline-block';
  saveBtn.style.display = 'none';
  cancelBtn.style.display = 'none';
}

// Function to delete a comment
function deleteComment(issueIndex, commentIndex) {
  if (!confirm('Are you sure you want to delete this comment?')) {
    return;
  }
  
  // Get current comments array
  const comments = rawIssues[issueIndex].notes.split(' | ');
  
  // Remove the specific comment
  comments.splice(commentIndex, 1);
  
  // Update the notes (empty string if no comments left)
  rawIssues[issueIndex].notes = comments.length > 0 ? comments.join(' | ') : '';
  
  // Save to localStorage for persistence
  saveToLocalStorage();
  
  // Re-render the table
  render();
}

// Functions for Next Steps functionality
// Function to add a next step to an issue
function addNextStep(issueIndex) {
  const stepTextarea = document.getElementById(`newNextStep_${issueIndex}`);
  const newStep = stepTextarea.value.trim();
  
  if (!newStep) {
    alert('Please enter a next step before adding.');
    return;
  }
  
  // Get current date for timestamp
  const now = new Date();
  const timestamp = (now.getMonth()+1).toString().padStart(2,'0') + '/' + 
                   now.getDate().toString().padStart(2,'0') + '/' + 
                   now.getFullYear() + ' ' + 
                   now.getHours().toString().padStart(2,'0') + ':' + 
                   now.getMinutes().toString().padStart(2,'0');
  
  // Format the new step with timestamp
  const formattedStep = `[${timestamp}] ${newStep}`;
  
  // Add to existing next steps or create new next steps
  if (rawIssues[issueIndex].next) {
    rawIssues[issueIndex].next += ` | ${formattedStep}`;
  } else {
    rawIssues[issueIndex].next = formattedStep;
  }
  
  // Save to localStorage for persistence
  saveToLocalStorage();
  
  // Debug: Log the updated next steps
  console.log('Updated next steps for issue', issueIndex, ':', rawIssues[issueIndex].next);
  
  // Clear the textarea
  stepTextarea.value = '';
  
  // Re-render the table to show the updated next steps
  render();
}

// Function to edit a next step
function editNextStep(issueIndex, stepIndex) {
  const textDiv = document.getElementById(`nextStepText_${issueIndex}_${stepIndex}`);
  const textarea = document.getElementById(`editNextStep_${issueIndex}_${stepIndex}`);
  const editBtn = document.getElementById(`editNextStepBtn_${issueIndex}_${stepIndex}`);
  const saveBtn = document.getElementById(`saveNextStepBtn_${issueIndex}_${stepIndex}`);
  const cancelBtn = document.getElementById(`cancelNextStepBtn_${issueIndex}_${stepIndex}`);
  
  textDiv.style.display = 'none';
  textarea.style.display = 'block';
  editBtn.style.display = 'none';
  saveBtn.style.display = 'inline-block';
  cancelBtn.style.display = 'inline-block';
  
  textarea.focus();
}

// Function to save edited next step
function saveNextStep(issueIndex, stepIndex) {
  const textarea = document.getElementById(`editNextStep_${issueIndex}_${stepIndex}`);
  const newText = textarea.value.trim();
  
  if (!newText) {
    alert('Next step cannot be empty.');
    return;
  }
  
  // Get current steps array
  const steps = rawIssues[issueIndex].next.split(' | ');
  
  // Update the specific step, preserving timestamp
  const timestampMatch = steps[stepIndex].match(/^(\[[^\]]+\])(.*)$/);
  if (timestampMatch) {
    steps[stepIndex] = timestampMatch[1] + ' ' + newText;
  } else {
    steps[stepIndex] = newText;
  }
  
  // Update the next steps
  rawIssues[issueIndex].next = steps.join(' | ');
  
  // Save to localStorage for persistence
  saveToLocalStorage();
  
  // Re-render the table
  render();
}

// Function to cancel edit next step
function cancelEditNextStep(issueIndex, stepIndex) {
  const textDiv = document.getElementById(`nextStepText_${issueIndex}_${stepIndex}`);
  const textarea = document.getElementById(`editNextStep_${issueIndex}_${stepIndex}`);
  const editBtn = document.getElementById(`editNextStepBtn_${issueIndex}_${stepIndex}`);
  const saveBtn = document.getElementById(`saveNextStepBtn_${issueIndex}_${stepIndex}`);
  const cancelBtn = document.getElementById(`cancelNextStepBtn_${issueIndex}_${stepIndex}`);
  
  textDiv.style.display = 'block';
  textarea.style.display = 'none';
  editBtn.style.display = 'inline-block';
  saveBtn.style.display = 'none';
  cancelBtn.style.display = 'none';
}

// Function to delete a next step
function deleteNextStep(issueIndex, stepIndex) {
  if (!confirm('Are you sure you want to delete this next step?')) {
    return;
  }
  
  // Get current steps array
  const steps = rawIssues[issueIndex].next.split(' | ');
  
  // Remove the specific step
  steps.splice(stepIndex, 1);
  
  // Update the next steps (empty string if no steps left)
  rawIssues[issueIndex].next = steps.length > 0 ? steps.join(' | ') : '';
  
  // Save to localStorage for persistence
  saveToLocalStorage();
  
  // Re-render the table
  render();
}

// Functions for editing Implementation Phase
function editPhase(index) {
  const display = document.getElementById(`phaseDisplay_${index}`);
  const edit = document.getElementById(`phaseEdit_${index}`);
  
  // Set current value in dropdown
  const currentPhase = rawIssues[index].phase || '';
  edit.value = currentPhase;
  
  // Toggle visibility
  display.style.display = 'none';
  edit.style.display = 'block';
  edit.focus();
}

function savePhase(index) {
  const edit = document.getElementById(`phaseEdit_${index}`);
  const newPhase = edit.value;
  
  // Update the data
  rawIssues[index].phase = newPhase;
  
  // Save to localStorage
  saveToLocalStorage();
  
  // Re-render the table
  render();
}

function cancelPhaseEdit(index) {
  const display = document.getElementById(`phaseDisplay_${index}`);
  const edit = document.getElementById(`phaseEdit_${index}`);
  
  // Revert visibility without saving
  display.style.display = 'inline';
  edit.style.display = 'none';
}

// Functions for editing Model Year
function editMy(index) {
  document.getElementById(`myDisplay_${index}`).style.display = 'none';
  const sel = document.getElementById(`myEdit_${index}`);
  sel.style.display = 'block';
  sel.value = rawIssues[index].modelYear || '';
  sel.focus();
}
function saveMy(index) {
  const sel = document.getElementById(`myEdit_${index}`);
  rawIssues[index].modelYear = sel.value;
  saveToLocalStorage();
  render();
}
function cancelMyEdit(index) {
  document.getElementById(`myDisplay_${index}`).style.display = 'inline-block';
  document.getElementById(`myEdit_${index}`).style.display = 'none';
}

// Functions for editing Priority
function editPriority(index) {
  const display = document.getElementById(`priorityDisplay_${index}`);
  const addBtn = document.getElementById(`addPriorityBtn_${index}`);
  const edit = document.getElementById(`priorityEdit_${index}`);
  
  // Set current value in dropdown
  const currentPriority = rawIssues[index].priority || '';
  edit.value = currentPriority;
  
  // Hide display/button and show dropdown
  if (display) display.style.display = 'none';
  if (addBtn) addBtn.style.display = 'none';
  edit.style.display = 'block';
  edit.focus();
}

function savePriority(index) {
  const edit = document.getElementById(`priorityEdit_${index}`);
  const newPriority = edit.value;
  
  // Update the data
  rawIssues[index].priority = newPriority;
  
  // Save to localStorage
  saveToLocalStorage();
  
  // Re-render the table
  render();
}

function cancelPriorityEdit(index) {
  const display = document.getElementById(`priorityDisplay_${index}`);
  const addBtn = document.getElementById(`addPriorityBtn_${index}`);
  const edit = document.getElementById(`priorityEdit_${index}`);
  
  // Revert visibility without saving
  if (display) display.style.display = 'inline';
  if (addBtn) addBtn.style.display = 'inline-block';
  edit.style.display = 'none';
}

// Functions for editing Item
function editItem(index) {
  const display = document.getElementById(`itemDisplay_${index}`);
  const edit = document.getElementById(`itemEdit_${index}`);
  const editBtn = document.getElementById(`itemEditBtn_${index}`);
  const actions = document.getElementById(`itemEditActions_${index}`);
  
  // Set current value in textarea
  edit.value = rawIssues[index].item || '';
  
  // Toggle visibility
  display.style.display = 'none';
  edit.style.display = 'block';
  editBtn.style.display = 'none';
  actions.style.display = 'block';
  edit.focus();
}

function saveItem(index) {
  const edit = document.getElementById(`itemEdit_${index}`);
  const newItem = edit.value.trim();
  
  if (!newItem) {
    alert('Item description cannot be empty.');
    return;
  }
  
  // Update the data
  rawIssues[index].item = newItem;
  
  // Save to localStorage
  saveToLocalStorage();
  
  // Re-render the table
  render();
}

function cancelItemEdit(index) {
  const display = document.getElementById(`itemDisplay_${index}`);
  const edit = document.getElementById(`itemEdit_${index}`);
  const editBtn = document.getElementById(`itemEditBtn_${index}`);
  const actions = document.getElementById(`itemEditActions_${index}`);
  
  // Revert visibility without saving
  display.style.display = 'block';
  edit.style.display = 'none';
  editBtn.style.display = 'inline-block';
  actions.style.display = 'none';
}

// Functions for editing Status
function editStatus(index) {
  const display = document.getElementById(`statusDisplay_${index}`);
  const edit = document.getElementById(`statusEdit_${index}`);
  
  // Set current value in dropdown
  const currentStatus = rawIssues[index].status || '';
  edit.value = currentStatus;
  
  // Toggle visibility
  display.style.display = 'none';
  edit.style.display = 'block';
  edit.focus();
}

function saveStatus(index) {
  const edit = document.getElementById(`statusEdit_${index}`);
  const newStatus = edit.value;
  
  // Update the data
  rawIssues[index].status = newStatus;
  
  // Save to localStorage
  saveToLocalStorage();
  
  // Re-render the table
  render();
}

function cancelStatusEdit(index) {
  const display = document.getElementById(`statusDisplay_${index}`);
  const edit = document.getElementById(`statusEdit_${index}`);
  
  // Revert visibility without saving
  display.style.display = 'inline';
  edit.style.display = 'none';
}

document.querySelectorAll('select,input').forEach(el=>el.addEventListener('input',render));

// Load saved data from localStorage on page load
loadFromLocalStorage();

render();

// Add New Issue Modal Logic
const addIssueBtn = document.getElementById('addIssueBtn');
const addIssueModal = document.getElementById('addIssueModal');
const cancelAddIssue = document.getElementById('cancelAddIssue');
const addIssueForm = document.getElementById('addIssueForm');

addIssueBtn.addEventListener('click',()=>{
  addIssueModal.style.display='flex';
});
cancelAddIssue.addEventListener('click',()=>{
  addIssueModal.style.display='none';
  addIssueForm.reset();
});
addIssueModal.addEventListener('click', e=>{
  if(e.target===addIssueModal){
    addIssueModal.style.display='none';
    addIssueForm.reset();
  }
});

addIssueForm.addEventListener('submit',e=>{
  e.preventDefault();
  // Get values
  const program = document.getElementById('newProgram').value;
  const priority = document.getElementById('newPriority').value;
  const item = document.getElementById('newItem').value;
  const status = document.getElementById('newStatus').value;
  const next = document.getElementById('newNext').value;
  const modelYear = document.getElementById('newMY').value;
  const phase = document.getElementById('newPhase').value;
  // Add to rawIssues
  const now = new Date();
  const timestamp = (now.getMonth()+1).toString().padStart(2,'0') + '/' +
                    now.getDate().toString().padStart(2,'0') + '/' +
                    now.getFullYear() + ' ' +
                    now.getHours().toString().padStart(2,'0') + ':' +
                    now.getMinutes().toString().padStart(2,'0');
  rawIssues.unshift({
    program,
    priority,
    item,
    status,
    next,
    target:'',
    modelYear,
    phase,
    notes:`[${timestamp}] Issue created`
  });
  
  // Save to localStorage for persistence
  saveToLocalStorage();
  
  render();
  addIssueModal.style.display='none';
  addIssueForm.reset();
});
// Font size slider: update --font-scale variable
const fontSlider = document.getElementById('fontSizeRange');
// Only update font-scale on change (click/release), ignore intermediate dragging
fontSlider.addEventListener('change', e => {
  document.documentElement.style.setProperty('--font-scale', e.target.value);
});
// Theme toggle: switch between dark and light modes
const themeBtn = document.getElementById('toggleThemeBtn');
// Initialize icon based on current mode
themeBtn.textContent = document.body.classList.contains('light-mode') ? '‚òÄÔ∏è' : 'üåô';
themeBtn.addEventListener('click', () => {
  const isLight = document.body.classList.toggle('light-mode');
  themeBtn.textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
});
</script>
</body>
</html>
